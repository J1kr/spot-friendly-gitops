apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: karpenter-nodeclass
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "0"    
spec:
  project: default
  destination:
    name: spot-friendly-cluster
    namespace: karpenter
  source:
    repoURL: https://charts.helm.sh/incubator
    targetRevision: "0.2.5"
    chart: raw
    helm:
      values: |-
        resources:
          - apiVersion: karpenter.k8s.aws/v1
            kind: EC2NodeClass
            metadata:
              name: default
            spec:
              amiFamily: AL2023
              amiSelectorTerms:
                - alias: al2023@latest
              role: "KarpenterNodeRole-spot-friendly-cluster"
              subnetSelectorTerms:
                - tags:
                    karpenter.sh/discovery: spot-friendly-cluster
              securityGroupSelectorTerms:
                - tags:
                    karpenter.sh/discovery: spot-friendly-cluster
              blockDeviceMappings:
                - deviceName: /dev/xvda
                  ebs:
                    volumeSize: 20Gi
                    volumeType: gp3
                    encrypted: true                    
  syncPolicy:
    automated:
      selfHeal: true
      prune: true
    syncOptions:
      - CreateNamespace=true
